# Flowable Ops Cleanup UI

Spring Boot (Java 17) UI and API for safely scanning and terminating long-running Flowable 6.7.2 process instances using Flowable Engine APIs by default (optionally supports native SQL reads for job/timer counts). Includes guardrails, audit logging, and robust deletion verification.

## Prerequisites
- Java 17
- Maven 3.8+
- Oracle JDBC driver available to the runtime
- Access to the Flowable database schema (Oracle)

## Build

```bash
mvn -DskipTests package
```

## Run

```bash
java -jar target/flowable-ops-cleanup-ui-1.0.0-SNAPSHOT.jar
```

Default UI: `http://localhost:8080/ops`

## Configuration
Edit `src/main/resources/application.yml` or provide overrides with `-Dspring.datasource.*`.

Key settings:

```yaml
ops:
  cleanup:
    enabled: true
    dryRun: true
    defaultHours: 6
    taskEscalationHours: 6
    maxPageSize: 200
    maxBulkDelete: 200
    retryCount: 2
    retryBackoffMillis: 500
    delayBetweenDeletesMillis: 50
    queryStrategy: API_ONLY
    nativeSql:
      tablePrefix: ACT_
      inClauseLimit: 1000
    audit:
      file: logs/ops-cleanup-audit.jsonl
      dbEnabled: false
    allowProcDefKeys: []
    denyProcDefKeys: []
  security:
    adminUsername: opsadmin
    adminPassword: "{bcrypt}$2a$10$7EqJtq98hPqEX7fNZaFWoOhi5o2m9c6gB9G1d/WQ5P6r6V5pY2"
    viewerUsername: opsviewer
    viewerPassword: "{bcrypt}$2a$10$7EqJtq98hPqEX7fNZaFWoOhi5o2m9c6gB9G1d/WQ5P6r6V5pY2"
```

Query strategy guidance:
- `API_ONLY` (default) uses Flowable APIs for all reads. Safest and most portable, but job/timer counts can be slower for very large datasets.
- `NATIVE_SQL` uses SQL reads only for job/timer counts to reduce query volume. Enable this only if native SQL reads are allowed in your environment.

## Security
- Basic auth + form login.
- `FLOWABLE_OPS_ADMIN` can terminate.
- `FLOWABLE_OPS_VIEWER` can view only.
- CSRF protection enabled for UI and API.
- Passwords must be stored as bcrypt hashes; `{noop}` (plain text) is rejected at startup.
- The sample bcrypt hashes map to a known default; replace them before production.

## Classification Rules
- **WAIT**: timers exist but not overdue OR tasks exist and oldest task age < escalation threshold.
- **ESCALATE**: tasks older than threshold OR overdue jobs/timers.
- **TERMINATE**: no open tasks, no timers, no overdue jobs/timers.

Classification maps to:
- **SAFE_TO_DELETE** for TERMINATE
- **REVIEW_ONLY** for WAIT/ESCALATE

## Deletion Safety
- Dry run is enabled by default (`ops.cleanup.dryRun=true`).
- Deletes happen via `runtimeService.deleteProcessInstance` only.
- Each delete is verified with runtime/task/job/timer/execution queries.
- Retries on optimistic locking with configurable backoff.
- Bulk deletes are capped by `maxBulkDelete`.
- Subprocesses are terminated before parents.
- Job/timer counts use Flowable APIs by default; you can enable native SQL reads via `ops.cleanup.queryStrategy: NATIVE_SQL` when permitted.

## Audit Logging
JSONL audit file contains timestamp, user, operation, result, and process metadata.
Optional DB table insert (disabled by default).

Suggested table:

```sql
CREATE TABLE OPS_CLEANUP_AUDIT (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY,
  EVENT_TIME TIMESTAMP DEFAULT SYSTIMESTAMP,
  OPERATION VARCHAR2(32),
  RESULT VARCHAR2(32),
  USERNAME VARCHAR2(128),
  HOSTNAME VARCHAR2(128),
  PID VARCHAR2(64),
  PROC_DEF_KEY VARCHAR2(128),
  REASON VARCHAR2(512),
  ERROR VARCHAR2(1024)
);
```

## Troubleshooting
- If deletes fail, check audit file `logs/ops-cleanup-audit.jsonl` for per-PID errors and verification snapshots.
- Ensure Flowable runtime tables and history are accessible to the DB user.
- Some environments hide `ACT_RU_PROCINST`; the app uses Flowable APIs and does not rely on direct SQL.

## Schema Selection
Switching between Flow and SmartFlow schemas is done via DB credentials in `spring.datasource.*`. The application uses Flowable APIs so schema visibility is determined by the DB user.

## REST API
- `GET /api/ops/processes`
- `GET /api/ops/processes/{pid}`
- `POST /api/ops/processes/terminate`
- `POST /api/ops/processes/terminateAll`
- `GET /api/ops/processes/export`

Example curl:

```bash
curl -u opsviewer:changeit "http://localhost:8080/api/ops/processes?hours=6&page=0&size=50"
```

```bash
curl -u opsadmin:changeit -H "Content-Type: application/json" \
  -H "X-CSRF-TOKEN: <token>" \
  -d '{"pids":["123"],"reason":"cleanup","token":"DELETE_TERMINATE","verify":true}' \
  http://localhost:8080/api/ops/processes/terminate
```

## UI Overview (Textual)
- Dashboard with filters, summary cards (WAIT/ESCALATE/TERMINATE), and paginated table.
- Bulk selection with terminate confirmation panel (token + reason).
- Details page with tasks, activities, jobs/timers, and terminate action.

