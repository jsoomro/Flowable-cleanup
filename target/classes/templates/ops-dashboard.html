<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <title>Flowable Ops Cleanup</title>
  <link rel="stylesheet" th:href="@{/css/ops.css}" />
</head>
<body>
  <header>
    <h1>Flowable Ops Cleanup</h1>
    <p th:text="${dryRun} ? 'Dry-run enabled: deletion calls are simulated' : 'Deletion enabled'">Dry-run enabled</p>
  </header>

  <div class="container">
    <div class="card">
      <div class="filters">
        <div>
          <label>Hours</label>
          <input id="hours" type="number" min="1" th:value="${defaultHours}" />
        </div>
        <div>
          <label>Action</label>
          <select id="action">
            <option value="ALL">All</option>
            <option value="WAIT">WAIT</option>
            <option value="ESCALATE">ESCALATE</option>
            <option value="TERMINATE">TERMINATE</option>
          </select>
        </div>
        <div>
          <label>Process Key</label>
          <input id="procDefKey" type="text" placeholder="procDefKey" />
        </div>
        <div>
          <label>Starter User</label>
          <input id="starterUserId" type="text" placeholder="userId" />
        </div>
        <div>
          <label>Has Tasks</label>
          <select id="hasTasks">
            <option value="">Any</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>
        <div>
          <label>Page Size</label>
          <input id="pageSize" type="number" min="1" value="50" />
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px;">
          <button onclick="loadData(0)">Apply Filters</button>
          <button class="secondary" onclick="exportCsv()">Export CSV</button>
        </div>
      </div>
    </div>

    <div class="summary">
      <div class="card">
        <h2 id="waitCount">0</h2>
        <span>WAIT</span>
      </div>
      <div class="card">
        <h2 id="escalateCount">0</h2>
        <span>ESCALATE</span>
      </div>
      <div class="card">
        <h2 id="terminateCount">0</h2>
        <span>TERMINATE</span>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <div>
          <button class="danger" onclick="openTerminateSelected()">Terminate Selected</button>
          <button class="danger" onclick="terminateAllTerminate()">Terminate All TERMINATE</button>
        </div>
        <div class="pagination">
          <button class="secondary" onclick="prevPage()">Prev</button>
          <span id="pageInfo">Page 1</span>
          <button class="secondary" onclick="nextPage()">Next</button>
        </div>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" onclick="toggleAll(this)" /></th>
            <th>PID</th>
            <th>Proc Key</th>
            <th>Hours</th>
            <th>Starter</th>
            <th>Tasks</th>
            <th>Timers</th>
            <th>Overdue Jobs</th>
            <th>Action</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>

    <div class="card" id="confirmPanel" style="display:none;">
      <h3>Confirm Termination</h3>
      <p class="notice">Bulk termination is irreversible. Provide a reason and the confirmation token.</p>
      <div class="filters">
        <div>
          <label>Reason</label>
          <textarea id="reason" rows="2" placeholder="Reason for termination"></textarea>
        </div>
        <div>
          <label>Confirmation Token</label>
          <input id="token" type="text" placeholder="DELETE_TERMINATE" />
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px;">
          <button class="danger" onclick="confirmTerminate()">Confirm</button>
          <button class="secondary" onclick="closeConfirm()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

<script>
let currentPage = 0;
let lastPage = 0;
let pendingMode = "selected";

function buildParams(page) {
  const hours = document.getElementById('hours').value;
  const action = document.getElementById('action').value;
  const procDefKey = document.getElementById('procDefKey').value;
  const starterUserId = document.getElementById('starterUserId').value;
  const hasTasks = document.getElementById('hasTasks').value;
  const size = document.getElementById('pageSize').value;
  const params = new URLSearchParams();
  params.set('hours', hours);
  if (action) params.set('action', action);
  if (procDefKey) params.set('procDefKey', procDefKey);
  if (starterUserId) params.set('starterUserId', starterUserId);
  if (hasTasks !== '') params.set('hasTasks', hasTasks);
  params.set('page', page);
  params.set('size', size);
  return params;
}

async function loadData(page) {
  currentPage = page;
  const params = buildParams(page);
  const res = await fetch('/api/ops/processes?' + params.toString());
  const data = await res.json();
  renderTable(data.items || []);
  renderSummary(data.summaryCounts || {});
  renderPageInfo(data.page || {});
}

function renderSummary(summary) {
  document.getElementById('waitCount').textContent = summary.waitCount || 0;
  document.getElementById('escalateCount').textContent = summary.escalateCount || 0;
  document.getElementById('terminateCount').textContent = summary.terminateCount || 0;
}

function renderPageInfo(page) {
  const totalPages = page.totalPages || 0;
  lastPage = totalPages > 0 ? totalPages - 1 : 0;
  document.getElementById('pageInfo').textContent = `Page ${page.page + 1 || 1} of ${totalPages || 1}`;
}

function renderTable(items) {
  const body = document.getElementById('resultsBody');
  body.innerHTML = '';
  items.forEach(item => {
    const row = document.createElement('tr');
    const badgeClass = item.recommendedAction ? item.recommendedAction.toLowerCase() : '';
    row.innerHTML = `
      <td><input type="checkbox" class="rowCheck" value="${item.processInstanceId}" /></td>
      <td>${item.processInstanceId}</td>
      <td>${item.processDefinitionKey || ''}</td>
      <td>${item.hoursRunning}</td>
      <td>${item.starterUserId || ''}</td>
      <td>${item.openTasksCount}</td>
      <td>${item.timerCount}</td>
      <td>${item.overdueJobCount}</td>
      <td><span class="badge ${badgeClass}">${item.recommendedAction || ''}</span></td>
      <td><a href="/ops/${item.processInstanceId}">Details</a></td>
    `;
    body.appendChild(row);
  });
}

function toggleAll(checkbox) {
  document.querySelectorAll('.rowCheck').forEach(cb => cb.checked = checkbox.checked);
}

function prevPage() {
  if (currentPage > 0) {
    loadData(currentPage - 1);
  }
}

function nextPage() {
  if (currentPage < lastPage) {
    loadData(currentPage + 1);
  }
}

function exportCsv() {
  const params = buildParams(currentPage);
  window.location = '/api/ops/processes/export?' + params.toString();
}

function openTerminateSelected() {
  pendingMode = 'selected';
  document.getElementById('confirmPanel').style.display = 'block';
}

function terminateAllTerminate() {
  pendingMode = 'all';
  document.getElementById('confirmPanel').style.display = 'block';
  document.getElementById('token').placeholder = 'DELETE_ALL_TERMINATE';
}

function closeConfirm() {
  document.getElementById('confirmPanel').style.display = 'none';
}

function getCsrf() {
  const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
  const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
  return { token, header };
}

async function confirmTerminate() {
  const reason = document.getElementById('reason').value;
  const token = document.getElementById('token').value;
  const csrf = getCsrf();

  if (pendingMode === 'selected') {
    const pids = Array.from(document.querySelectorAll('.rowCheck:checked')).map(cb => cb.value);
    const res = await fetch('/api/ops/processes/terminate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        [csrf.header]: csrf.token
      },
      body: JSON.stringify({ pids, reason, token, verify: true })
    });
    await res.json();
  } else {
    const params = buildParams(currentPage);
    const hours = document.getElementById('hours').value;
    const action = 'TERMINATE';
    const procDefKey = document.getElementById('procDefKey').value;
    const res = await fetch('/api/ops/processes/terminateAll', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        [csrf.header]: csrf.token
      },
      body: JSON.stringify({ hours, action, procDefKey, reason, token })
    });
    await res.json();
  }
  closeConfirm();
  loadData(currentPage);
}

loadData(0);
</script>
</body>
</html>
